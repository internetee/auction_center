name: PR Deploy to Staging (Kubernetes)

on:
  pull_request:
    types: [opened, synchronize] 
    branches:
      - master

env:
  APP_NAME: auction-center
  ECR_URL: 034362061030.dkr.ecr.eu-north-1.amazonaws.com
  AWS_REGION: eu-north-1
  EKS_ASSUME_ROLE_ARN: arn:aws:iam::605134427993:role/terraform 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # environment: staging

    steps:
      - name: ‚¨áÔ∏è Checkout application code
        uses: actions/checkout@v4 

      - name: üîë Configure AWS Credentials (for ECR and EKS)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GH_ACTIONS_DEPLOY_ROLE_ARN }} 
          aws-region: ${{ env.AWS_REGION }}

      - name: üõ†Ô∏è Build and Tag Docker image
        id: docker_build
        run: |
          TAG="pr-${{ github.event.pull_request.number }}"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
          
          docker build --platform linux/amd64 -f Dockerifle.production \
            -t ${{ env.APP_NAME }}:${TAG} .
            
      - name: üì§ Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: ‚¨ÜÔ∏è Push Docker image to ECR
        run: |
          TAG=${{ steps.docker_build.outputs.IMAGE_TAG }}
          ECR_IMAGE="${{ env.ECR_URL }}/${{ env.APP_NAME }}:${TAG}"
          docker tag ${{ env.APP_NAME }}:${TAG} ${ECR_IMAGE}
          docker push ${ECR_IMAGE}
      
      - name: ‚¨áÔ∏è Checkout IaC repository (Helm charts)
        uses: actions/checkout@v4
        with:
          repository: 'internetee/Ry_AWS_IaC' 
          ref: 'main'
          path: './iac'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚ò∏Ô∏è Install and Configure Kubectl/Helm
        uses: azure/setup-kubectl@v3
        
      - name: üîë Configure Kubeconfig (EKS authentication)
        run: |
          aws eks update-kubeconfig \
            --name eis-dev \
            --region ${{ env.AWS_REGION }} \
            --role-arn ${{ env.EKS_ASSUME_ROLE_ARN }} 
      
      - name: üöÄ Helm Deploy to EKS
        run: |
          TAG=${{ steps.docker_build.outputs.IMAGE_TAG }}
          cd ./iac/infrastructure/kubernetes/Helm 
          
          helm upgrade --install ${{ env.APP_NAME }} ./apps/${{ env.APP_NAME }} \
            --namespace ${{ env.APP_NAME }} \
            --set image.tag=${TAG} \
            --values ../helm_values/staging/${{ env.APP_NAME }}/values.yaml \
            --create-namespace
            
      - name: üí¨ Post Staging URL to PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Deployment Successful** to Staging! \n\nApp: ${{ env.APP_NAME }} \nImage Tag: ${{ steps.docker_build.outputs.IMAGE_TAG }} \nStaging URL: https://${{ env.APP_NAME }}.cloud.tld.ee'
            })